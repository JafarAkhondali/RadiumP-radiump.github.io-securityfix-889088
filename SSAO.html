 <!DOCTYPE html>
 <!--Reference:"http://alteredqualia.com"-->



<html lang="en">
	<head>
		<title>three.js webgl - postprocessing - Screen Space Ambient Occlusion</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				background-color: #000000;
				margin: 0px;
				overflow: hidden;
				font-family:Monospace;
				font-size:13px;
				text-align:center;
				font-weight: bold;
			}

			a {
				color:#00ff78;
			}

			#info {
				color: #fff;
				position: absolute;
				top: 0px;
				width: 100%;
				padding: 5px;
			}
			.dg.ac {
				z-index: 1 !important; /* FIX DAT.GUI */
			}
		</style>
	</head>
	<body>
		<script src="build/three.js"></script>
		<script src="js/shaders/SSAOShader.js"></script>
		<script src="js/shaders/CopyShader.js"></script>
		<script src="js/postprocessing/RenderPass.js"></script>
		<script src="js/postprocessing/ShaderPass.js"></script>
		<script src="js/postprocessing/MaskPass.js"></script>
		<script src="js/postprocessing/EffectComposer.js"></script>
		<script src="js/Detector.js"></script>
		<script src="js/libs/stats.min.js"></script>
		<script src="js/libs/Coordinates.js"></script>
		<script src='js/libs/dat.gui.min.js'></script>
		<script src="js/controls/OrbitControls.js"></script>
		<script src="js/loaders/OBJLoader.js"></script>

		<div id="info">
			<a href="http://threejs.org" target="_blank">three.js</a> - webgl screen space ambient occlusion example<br/>
			shader by <a href="http://alteredqualia.com">alteredq</a>
		</div>

		<script>
			if(!Detector.webgl) Detector.addGetWebGLMessage();

			var container, stats;
			var camera, scene, renderer;
			var depthMaterial, effectComposer, depthRenderTarget;
			var ssaoPass;
			var bird;
			var tiltDirection = 1;
			var depthScale = 1.0;
			var postprocessing = {enabled:true,renderMode:0};
			var controls;
			var light;
			var bevelRadius = 1.9;    // TODO: 2.0 causes some geometry bug.
			var ground;
			var solidGround;

			init();
			animate();
			
			function init(){

				container = document.createElement('div');
				document.body.appendChild(container);

				renderer = new THREE.WebGLRenderer({antialias:false});
				renderer.setClearColor(0xa0a0a0);
				renderer.setPixelRatio(window.devicePixelRatio);
				renderer.setSize(window.innerWidth, window.innerHeight);
				document.body.appendChild(renderer.domElement);

				camera = new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,100,3000);
				camera.position.z = 800;

				
				controls = new THREE.OrbitControls(camera,renderer.domElement);
				controls.enableDamping = true;//// If damping is enabled, you must call controls.update() in your animation loop
				controls.dampingFactor = 0.25;
				controls.enableZoom = true;

				scene = new THREE.Scene();

				light = new THREE.DirectionalLight( 0xffffff );
				light.position.set( 1, 1, 1 );
				scene.add( light );

				light = new THREE.DirectionalLight( 0x002288 );
				light.position.set( -1, -1, -1 );
				scene.add( light );

				light = new THREE.AmbientLight( 0x222222 );
				scene.add( light );

				// Glass
   				var glass = createGlass(260);
   				glass.position.x = -245;
   				glass.position.y = 125;
   				glass.position.z = 0;
   				scene.add(glass);

				bird = new THREE.Object3D();
				createDrinkingBird( bird );
				scene.add(bird);
				
				Coordinates.drawGround({size:10000});
				Coordinates.drawGrid({size:10000,scale:0.01});

				var loader = new THREE.OBJLoader();

				// load a resource
				loader.load(
				// resource URL
				'http://www.public.asu.edu/~chenyan5/src/luffy.obj',
				// Function when resource is loaded
					function ( object ) {
						scene.add( object );
					}
				);

				stats = new Stats();
				stats.domElement.style.postion = 'absolute';
				stats.domElement.style.top = '0px';
				container.appendChild(stats.domElement);

				initPostprocessing();

				var gui = new dat.GUI();
				gui.add(postprocessing,"enabled").onChange();
				gui.add(postprocessing,"renderMode",{framebuffer:0, onlyAO:1}).onChange(renderModeChange).listen();

				window.addEventListener('resize',onWindowResize,false);




			}

			function createGlass(height) {
			    var cupMaterial = new THREE.MeshPhongMaterial( { color: 0x0, specular: 0xFFFFFF, shininess: 100, opacity: 0.3, transparent: true } );
			    var waterMaterial = new THREE.MeshLambertMaterial( {
			        color: 0x1F8BAF,
			        opacity: 0.7,
			        transparent: true
			    } );

			    var glassGeometry = new THREE.CylinderGeometry(120, 100, height, 32);
			    var glassMesh = new THREE.Mesh( glassGeometry, cupMaterial );
			    var glassObject = new THREE.Object3D();
			    glassObject.add(glassMesh);
			    
			    var glassWater = new THREE.Mesh( new THREE.CylinderGeometry(120, 100, height, 32), waterMaterial);
			    glassWater.scale = new THREE.Vector3(0.9, 0.85, 0.9);
			    glassWater.position.y = -10;
			    glassObject.add(glassWater);
			    return glassObject;
			}


			// Supporting frame for the bird - base + legs + feet
			function createSupport( bsupport ) {
			    var legMaterial = new THREE.MeshPhongMaterial( { shininess: 4 } );
			    legMaterial.color.setHex( 0xAdA79b );
			    legMaterial.specular.setRGB( 0.5, 0.5, 0.5 );
			    //legMaterial.side = THREE.BackSide;

			    //legMaterial.ambient.copy( legMaterial.color );
			                
			    var footMaterial = new THREE.MeshPhongMaterial( { color: 0x960f0b, shininess: 30 } );
			    footMaterial.specular.setRGB( 0.5, 0.5, 0.5 );
			    //footMaterial.ambient.copy( footMaterial.color );
			                
			    // base
			    // cube = new THREE.Mesh( 
			    //     new THREE.BeveledBlockGeometry( 20+64+110, 4, 2*77+12, bevelRadius ), footMaterial );
			    // cube.position.x = -45;    // (20+32) - half of width (20+64+110)/2
			    // cube.position.y = 4/2;    // half of height
			    // cube.position.z = 0;    // centered at origin
			    // bsupport.add( cube );
			                
			    // // feet
			    // cube = new THREE.Mesh( 
			    //     new THREE.BeveledBlockGeometry( 20+64+110, 52, 6, bevelRadius ), footMaterial );
			    // cube.position.x = -45;    // (20+32) - half of width (20+64+110)/2
			    // cube.position.y = 52/2;    // half of height
			    // cube.position.z = 77 + 6/2;    // offset 77 + half of depth 6/2
			    // bsupport.add( cube );
			                
			    // cube = new THREE.Mesh( 
			    //     new THREE.BeveledBlockGeometry( 20+64+110, 52, 6, bevelRadius ), footMaterial );
			    // cube.position.x = -45;    // (20+32) - half of width (20+64+110)/2
			    // cube.position.y = 52/2;    // half of height
			    // cube.position.z = -(77 + 6/2);    // negative offset 77 + half of depth 6/2
			    // bsupport.add( cube );
			                
			    // cube = new THREE.Mesh( 
			    //     new THREE.BeveledBlockGeometry( 64, 104, 6, bevelRadius ), footMaterial );
			    // cube.position.x = 0;    // centered on origin along X
			    // cube.position.y = 104/2;
			    // cube.position.z = 77 + 6/2;    // negative offset 77 + half of depth 6/2
			    // bsupport.add( cube );
			                
			    // cube = new THREE.Mesh( 
			    //     new THREE.BeveledBlockGeometry( 64, 104, 6, bevelRadius ), footMaterial );
			    // cube.position.x = 0;    // centered on origin along X
			    // cube.position.y = 104/2;
			    // cube.position.z = -(77 + 6/2);    // negative offset 77 + half of depth 6/2
			    // bsupport.add( cube );
			                
			    // // legs
			    // cube = new THREE.Mesh( 
			    //     new THREE.BeveledBlockGeometry( 60, 282+4, 4, bevelRadius ), legMaterial );
			    // cube.position.x = 0;    // centered on origin along X
			    // cube.position.y = 104 + 282/2 - 2;
			    // cube.position.z = 77 + 6/2;    // negative offset 77 + half of depth 6/2
			    // bsupport.add( cube );
			                
			    // cube = new THREE.Mesh( 
			    //     new THREE.BeveledBlockGeometry( 60, 282+4, 4, bevelRadius ), legMaterial );
			    // cube.position.x = 0;    // centered on origin along X
			    // cube.position.y = 104 + 282/2 - 2;
			    // cube.position.z = -(77 + 6/2);    // negative offset 77 + half of depth 6/2
			    // bsupport.add( cube );
			}

			// Body of the bird - body and the connector of body and head
			function createBody(bbody) {
			    var bodyMaterial = new THREE.MeshPhongMaterial( { shininess: 100 } );
			    bodyMaterial.color.setRGB( 31/255, 86/255, 169/255 );
			    bodyMaterial.specular.setRGB( 0.5, 0.5, 0.5 );
			    //bodyMaterial.ambient.copy( bodyMaterial.color );

			    var glassMaterial = new THREE.MeshPhongMaterial( { color: 0x0, specular: 0xFFFFFF, shininess: 100, opacity: 0.3, transparent: true } );
			    //glassMaterial.ambient.copy( glassMaterial.color );

			    var crossbarMaterial = new THREE.MeshPhongMaterial( { color: 0x808080, specular: 0xFFFFFF, shininess: 400 } );
			    //crossbarMaterial.ambient.copy( crossbarMaterial.color );

			    // body
			    sphere = new THREE.Mesh(
			        new THREE.SphereGeometry( 104/2, 32, 16, 0, Math.PI * 2, Math.PI/2, Math.PI ), bodyMaterial );
			    sphere.position.x = 0;
			    sphere.position.y = 160;
			    sphere.position.z = 0;
			    bbody.add( sphere );
			    
			    // cap for top of hemisphere
			    cylinder = new THREE.Mesh( 
			        new THREE.CylinderGeometry( 104/2, 104/2, 0, 32 ), bodyMaterial );
			    cylinder.position.x = 0;
			    cylinder.position.y = 160;
			    cylinder.position.z = 0;
			    bbody.add( cylinder );        

			    cylinder = new THREE.Mesh( 
			        new THREE.CylinderGeometry( 12/2, 12/2, 390 - 100, 32 ), bodyMaterial );
			    cylinder.position.x = 0;
			    cylinder.position.y = 160 + 390/2 - 100;
			    cylinder.position.z = 0;
			    bbody.add( cylinder );
			    
			    // glass stem
			    sphere = new THREE.Mesh(
			        new THREE.SphereGeometry( 116/2, 32, 16 ), glassMaterial );
			    sphere.position.x = 0;
			    sphere.position.y = 160;
			    sphere.position.z = 0;
			    bbody.add( sphere );

			    cylinder = new THREE.Mesh( 
			        new THREE.CylinderGeometry( 24/2, 24/2, 390, 32 ), glassMaterial );
			    cylinder.position.x = 0;
			    cylinder.position.y = 160 + 390/2;
			    cylinder.position.z = 0;
			    bbody.add( cylinder );
			        
			    // crossbar    
			    cylinder = new THREE.Mesh( 
			        new THREE.CylinderGeometry( 5, 5, 200, 32 ), crossbarMaterial );
			    cylinder.position.set( 0, 360, 0 );
			    cylinder.rotation.x = 90 * Math.PI / 180.0;
			    bbody.add( cylinder );
			}

			// Head of the bird - head + hat
			function createHead(bhead) {
			    var headMaterial = new THREE.MeshLambertMaterial( );
			    headMaterial.color.r = 104/255;
			    headMaterial.color.g = 1/255;
			    headMaterial.color.b = 5/255;
			    //headMaterial.ambient.copy( headMaterial.color );
			                
			    var hatMaterial = new THREE.MeshPhongMaterial( { shininess: 100 } );
			    hatMaterial.color.r = 24/255;
			    hatMaterial.color.g = 38/255;
			    hatMaterial.color.b = 77/255;
			    hatMaterial.specular.setRGB( 0.5, 0.5, 0.5 );
			   // hatMaterial.ambient.copy( hatMaterial.color );

			    var eyeMaterial = new THREE.MeshPhongMaterial( { color: 0x000000, specular: 0x303030, shininess: 4 } );
			    //eyeMaterial.ambient.copy( eyeMaterial.color );
			    
			    // head
			    sphere = new THREE.Mesh(
			        new THREE.SphereGeometry( 104/2, 32, 16 ), headMaterial );
			    sphere.position.x = 0;
			    sphere.position.y = 160 + 390;
			    sphere.position.z = 0;
			    bhead.add( sphere );

			    // hat
			    cylinder = new THREE.Mesh( 
			        new THREE.CylinderGeometry( 142/2, 142/2, 10, 32 ), hatMaterial );
			    cylinder.position.x = 0;
			    cylinder.position.y = 160 + 390 + 40 + 10/2;
			    cylinder.position.z = 0;
			    bhead.add( cylinder );
			                
			    cylinder = new THREE.Mesh( 
			        new THREE.CylinderGeometry( 80/2, 80/2, 70, 32 ), hatMaterial );
			    cylinder.position.x = 0;
			    cylinder.position.y = 160 + 390 + 40 + 10 + 70/2;
			    cylinder.position.z = 0;
			    bhead.add( cylinder );

			    // nose
			    cylinder = new THREE.Mesh( 
			        new THREE.CylinderGeometry( 6, 14, 70, 32 ), headMaterial );
			    cylinder.position.set( -70, 530, 0 );
			    cylinder.rotation.z = 90 * Math.PI / 180.0;
			    bhead.add( cylinder );

			    // eyes
			    var sphGeom = new THREE.SphereGeometry( 10, 32, 16 );
			    
			    // left eye
			    sphere = new THREE.Mesh( sphGeom, eyeMaterial );
			    sphere.position.set( -48, 560, 0 );
			    var eye = new THREE.Object3D();    
			    eye.add( sphere );
			    eye.rotation.y = 20 * Math.PI / 180.0;
			    bhead.add( eye );

			    // right eye
			    sphere = new THREE.Mesh( sphGeom, eyeMaterial );
			    sphere.position.set( -48, 560, 0 );
			    eye = new THREE.Object3D();    
			    eye.add( sphere );
			    eye.rotation.y = -20 * Math.PI / 180.0;
			    bhead.add( eye );
			}

			function createDrinkingBird(bbird) {
			    var support = new THREE.Object3D();
			    var body = new THREE.Object3D();
			    var head = new THREE.Object3D();
			    
			    // MODELS
			    // base + legs + feet
			    createSupport(support);
			    
			    // body + body/head connector
			    createBody(body);

			    // head + hat
			    createHead(head);
			    
			    // make moving piece
			    
			    var bodyhead = new THREE.Object3D();
			    bodyhead.add(body);
			    bodyhead.add(head);

			    // Student: change pivot point
			    // pivotHeight is the height of the crossbar
			    var pivotHeight = 360;
			    bodyhead.position.y = pivotHeight;
			    body.position.y = -pivotHeight;
			    head.position.y = -pivotHeight;
			    // add field for animated part, for simplicity
			    bbird.animated = bodyhead;
			    
			    bbird.add(support);
			    bbird.add(bodyhead);

			    // go through all objects and set the meshes (only)
			    // so that they cast shadows
			    bbird.traverse( function ( object ) {
			        if ( object instanceof THREE.Mesh ) {
			            object.castShadow = true;
			            object.receiveShadow = true;
			        }
			    } );
			    
			}


			function renderModeChange(value){

				if(value == 0){
					ssaoPass.uniforms['onlyAO'].value = false;
				}
				else if(value == 1){
					ssaoPass.uniforms['onlyAO'].value = true;
				}
				else{
					console.error("Not define renderModeChange type: " + value );
				}

			}


			function onWindowResize(){

				var width = window.innerWidth;
				var height = window.innerHeight;

				camera.aspect = width / height;
				camera.updateProjectionMatrix();
				renderer.setSize(width, height);

				ssaoPass.uniforms['size'].value.set(width,height);

				var pixelRatio = renderer.getPixelRatio();
				var newWidth = Math.floor(width / pixelRatio)||1;
				var newHeight = Math.floor(height / pixelRatio)||1;
				depthRenderTarget.setSize(newWidth, newHeight);
				effectComposer.setSize(newWidth, newHeight);
			}


			function initPostprocessing(){

				var renderPass = new THREE.RenderPass(scene, camera);

				var depthShader = THREE.ShaderLib["depthRGBA"];
				var depthUniforms = THREE.UniformsUtils.clone(depthShader.uniforms);

				depthMaterial = new THREE.ShaderMaterial({fragmentShader:depthShader.fragmentShader, vertexShader:depthShader.vertexShader, uniforms:depthUniforms, blending: THREE.NoBlending});

				var pars = { minFilter: THREE.LinearFilter, magFilter: THREE.LinearFilter };
				depthRenderTarget = new THREE.WebGLRenderTarget( window.innerWidth, window.innerHeight, pars );

				ssaoPass = new THREE.ShaderPass(THREE.SSAOShader);
				ssaoPass.renderToScreen = true;
				ssaoPass.uniforms['tDepth'].value = depthRenderTarget;
				ssaoPass.uniforms['size'].value.set(window.innerWidth, window.innerHeight);
				ssaoPass.uniforms['cameraNear'].value = camera.near;
				ssaoPass.uniforms['onlyAO'].value = (postprocessing.renderMode == 1);
				ssaoPass.uniforms['aoClamp'].value = 0.3;
				ssaoPass.uniforms['lumInfluence'].value = 0.5;

				effectComposer = new THREE.EffectComposer(renderer);
				effectComposer.addPass(renderPass);
				effectComposer.addPass(ssaoPass);

				
			}


			function animate() {
				requestAnimationFrame( animate );

				render();
				stats.update();
			}

			function render(){
				//var timer = performance.now(); //animation
				//drinkingBird.rotation.x = timer * 0.0002; 
				bird.animated.rotation.z += tiltDirection * 0.5 * Math.PI/180;
    			if ( bird.animated.rotation.z > 103 * Math.PI/180 ) {
        			tiltDirection = -1;
        			bird.animated.rotation.z = 2*(103 * Math.PI/180) - bird.animated.rotation.z;
    			} 
    			else if ( bird.animated.rotation.z < -22 * Math.PI/180 ) {
        			tiltDirection = 1;
        			bird.animated.rotation.z = 2*(-22 * Math.PI/180) - bird.animated.rotation.z;
    			}


				if ( postprocessing.enabled ) {

					// Render depth into depthRenderTarget
					scene.overrideMaterial = depthMaterial;
					renderer.render( scene, camera, depthRenderTarget, true );

					// Render renderPass and SSAO shaderPass
					scene.overrideMaterial = null;
					effectComposer.render();

				} else {
					renderer.render( scene, camera );
				}
			}

			
			




		</script>
	</body>
</html>
